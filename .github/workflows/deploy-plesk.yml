name: ðŸš€ Deploy to Windows Plesk Hosting

on:
  push:
    branches:
      - master
      - develop
  workflow_dispatch:
    inputs:
      version_type:
        description: "Version type (patch/minor/major)"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major

env:
  NODE_VERSION: "18"
  VITE_API_BASE_URL: "https://api.pardistous.ir"

jobs:
  # âœ… ØªØ´Ø®ÛŒØµ Ù†ÙˆØ¹ ØªØºÛŒÛŒØ±Ø§Øª
  detect-version-type:
    name: ðŸ” Detect Version Type
    runs-on: ubuntu-latest
    outputs:
      version-type: ${{ steps.detect.outputs.version-type }}
      should-deploy: ${{ steps.detect.outputs.should-deploy }}
      commit-message: ${{ steps.detect.outputs.commit-message }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Detect version type
        id: detect
        run: |
          # Ø§Ú¯Ø± manual trigger Ø¨Ø§Ø´Ø¯ØŒ Ø§Ø² input Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION_TYPE="${{ github.event.inputs.version_type }}"
          else
            # ØªØ´Ø®ÛŒØµ Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ø² commit message
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            
            if [[ "$COMMIT_MSG" =~ ^(feat|feature)(\(.+\))?!: ]] || [[ "$COMMIT_MSG" =~ BREAKING[[:space:]]CHANGE ]]; then
              VERSION_TYPE="major"
            elif [[ "$COMMIT_MSG" =~ ^(feat|feature)(\(.+\))?: ]]; then
              VERSION_TYPE="minor"
            else
              VERSION_TYPE="patch"
            fi
          fi

          SHOULD_DEPLOY="true"
          if [[ "${{ github.ref_name }}" != "main" ]]; then
            SHOULD_DEPLOY="false"
          fi

          echo "version-type=$VERSION_TYPE" >> $GITHUB_OUTPUT
          echo "should-deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
          echo "commit-message=${{ github.event.head_commit.message }}" >> $GITHUB_OUTPUT

          echo "ðŸŽ¯ Version type: $VERSION_TYPE"
          echo "ðŸš€ Should deploy: $SHOULD_DEPLOY"

  # âœ… Build Ø¨Ø±Ø§ÛŒ Windows Hosting
  build-and-deploy:
    name: ðŸ—ï¸ Build & Deploy to Plesk
    runs-on: ubuntu-latest
    needs: detect-version-type
    if: needs.detect-version-type.outputs.should-deploy == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: ðŸ”„ Update version
        run: |
          VERSION_TYPE="${{ needs.detect-version-type.outputs.version-type }}"
          echo "Updating version with type: $VERSION_TYPE"
          npm run version:$VERSION_TYPE

      - name: ðŸ“Š Show version info
        run: npm run version:show

      - name: ðŸ—ï¸ Build for Windows hosting
        run: npm run build:production
        env:
          NODE_ENV: production
          VITE_API_BASE_URL: ${{ env.VITE_API_BASE_URL }}

      - name: ðŸ“¦ Prepare deployment package
        run: |
          # Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§ØªÛŒ Ø¨Ø±Ø§ÛŒ Ø³Ø±ÙˆØ±
          NEW_VERSION=$(cat version.json | jq -r '.version')
          echo "$NEW_VERSION" > dist/version.txt
          echo "$(date -u +%Y-%m-%dT%H:%M:%SZ)" > dist/build-date.txt

          # Ø§ÛŒØ¬Ø§Ø¯ web.config Ø¨Ø±Ø§ÛŒ IIS (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
          cat > dist/web.config << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <configuration>
            <system.webServer>
              <rewrite>
                <rules>
                  <rule name="React Routes" stopProcessing="true">
                    <match url=".*" />
                    <conditions logicalGrouping="MatchAll">
                      <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
                      <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
                    </conditions>
                    <action type="Rewrite" url="/" />
                  </rule>
                </rules>
              </rewrite>
              <staticContent>
                <mimeMap fileExtension=".json" mimeType="application/json" />
                <mimeMap fileExtension=".woff" mimeType="application/font-woff" />
                <mimeMap fileExtension=".woff2" mimeType="application/font-woff2" />
              </staticContent>
              <httpCompression>
                <dynamicTypes>
                  <add mimeType="application/json" enabled="true" />
                  <add mimeType="application/javascript" enabled="true" />
                  <add mimeType="text/css" enabled="true" />
                </dynamicTypes>
              </httpCompression>
            </system.webServer>
          </configuration>
          EOF

          # Ø§ÛŒØ¬Ø§Ø¯ .htaccess Ø¨Ø±Ø§ÛŒ Apache (Ø§Ú¯Ø± Ø³Ø±ÙˆØ± Ø§Ø² Apache Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†Ø¯)
          cat > dist/.htaccess << 'EOF'
          RewriteEngine On
          RewriteBase /

          # Handle client-side routing
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteRule . /index.html [L]

          # Enable compression
          <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE text/plain
            AddOutputFilterByType DEFLATE text/html
            AddOutputFilterByType DEFLATE text/xml
            AddOutputFilterByType DEFLATE text/css
            AddOutputFilterByType DEFLATE application/xml
            AddOutputFilterByType DEFLATE application/xhtml+xml
            AddOutputFilterByType DEFLATE application/rss+xml
            AddOutputFilterByType DEFLATE application/javascript
            AddOutputFilterByType DEFLATE application/x-javascript
            AddOutputFilterByType DEFLATE application/json
          </IfModule>

          # Cache static assets
          <IfModule mod_expires.c>
            ExpiresActive on
            ExpiresByType text/css "access plus 1 year"
            ExpiresByType application/javascript "access plus 1 year"
            ExpiresByType image/png "access plus 1 year"
            ExpiresByType image/jpg "access plus 1 year"
            ExpiresByType image/jpeg "access plus 1 year"
            ExpiresByType image/gif "access plus 1 year"
            ExpiresByType image/svg+xml "access plus 1 year"
          </IfModule>
          EOF

      - name: ðŸš€ Deploy to Plesk via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ftp.pardistous.ir
          username: front
          password: ewan1384@
          local-dir: ./dist/
          server-dir: ./
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.env*
          log-level: verbose

      - name: ðŸ“ Commit version changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          git add package.json version.json src/utils/cacheManager.js public/sw.js

          if ! git diff --cached --quiet; then
            NEW_VERSION=$(cat version.json | jq -r '.version')
            git commit -m "ðŸ”– Bump version to $NEW_VERSION [skip ci]"
            git push
            
            # Create tag
            git tag -a "$NEW_VERSION" -m "Release $NEW_VERSION"
            git push origin "$NEW_VERSION"
          fi

      - name: ðŸ“¢ Deployment Summary
        run: |
          NEW_VERSION=$(cat version.json | jq -r '.version')
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** $NEW_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Type:** ${{ needs.detect-version-type.outputs.version-type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ needs.detect-version-type.outputs.commit-message }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** âœ… Deployed Successfully" >> $GITHUB_STEP_SUMMARY
